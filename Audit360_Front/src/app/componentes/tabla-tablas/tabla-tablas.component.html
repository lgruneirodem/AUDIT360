<!-- Caja de filtros mejorada -->
<ion-card class="header-card">
  <ion-card-content>
    <h1 class="title">Administración de Tablas</h1>
    <p class="breadcrumb">Base de datos > Tablas > Gestión</p>

    <div class="connection-status">
      <ion-icon
        name="ellipse"
        color="success"
        style="font-size: 8px"
      ></ion-icon>
      <span class="status-text">Conectado a la base de datos</span>
    </div>
  </ion-card-content>
</ion-card>

<!-- Barra de acciones -->
<ion-toolbar class="action-toolbar">
  <ion-buttons slot="start" class="action-buttons">
    <ion-button color="primary" fill="solid"  (click)="nuevaTabla()"> Nueva Tabla </ion-button>

    <ion-button fill="outline" color="medium"> Sincronizar Schema </ion-button>

    <ion-button color="warning" fill="solid"> Respaldar Tablas </ion-button>
  </ion-buttons>

  <ion-searchbar
    placeholder="Buscar tablas..."
    slot="start"
    class="custom-searchbar"
  >
  </ion-searchbar>
</ion-toolbar>

<!-- Resultados y estadísticas -->
<div class="results-summary" *ngIf="tablaFiltrada.length > 0">
  <ion-chip color="primary" class="result-chip">
    <ion-icon name="list-outline"></ion-icon>
    <ion-label>{{ tablaFiltrada.length }} tabla(s) encontrada(s)</ion-label>
  </ion-chip>
</div>

<!-- Tabla de resultados mejorada -->
<div class="table-container">
  <ion-card class="table-card">
    <ion-card-header>
      <ion-card-title>Tablas de la Base de Datos</ion-card-title>
      <ion-note>{{ tablaFiltrada.length }} tablas encontradas</ion-note>
    </ion-card-header>
    <ion-card-content class="table-content">
      <ion-grid class="table-grid">
        

        <ion-row
          *ngFor="let table of tablas; let i = index"
          class="table-row"
          [class.inactiva]="table.status === 'INACTIVA'"
        >
          <ion-col size="3">
            <strong>{{ table.name }}</strong>
          </ion-col>

          <ion-col size="3">
            {{ table.columns }} columnas • {{ table.rows | number }} registros
          </ion-col>

          <ion-col size="3">
            {{ table.lastModified | date : 'dd/MM/yyyy' }}
          </ion-col>

          <ion-col size="1">
            <ion-badge
              [color]="table.status === 'ACTIVA' ? 'success' : 'danger'"
            >
              {{ table.status }}
            </ion-badge>
          </ion-col>

          <ion-col size="2">
            <ion-button fill="clear" size="small" color="primary" >Ver</ion-button>
            <ion-button fill="clear" size="small" color="tertiary" (click)="configurarTabla(table)">Editar</ion-button>
            <ion-button fill="clear" size="small" color="warning" >Auditar</ion-button>
            <ion-button *ngIf="table.status === 'INACTIVA'" fill="solid" size="small" color="danger" >Eliminar</ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>
</div>

<!-- Cards para móvil -->
<div class="mobile-cards" *ngIf="isMobile">
  <ion-card
    *ngFor="let table of tablaFiltrada"
    class="mobile-table-card"
    
  >
    <ion-card-header>
      <div class="mobile-card-header">
        <div class="table-info">
          <ion-card-title>{{ table.name }}</ion-card-title>
          <ion-card-subtitle>{{ table.schema }}</ion-card-subtitle>
        </div>
        <ion-badge
          [color]="getStatusColor(table.status)"
          class="mobile-status-badge"
        >
          {{ table.status }}
        </ion-badge>
      </div>
    </ion-card-header>

    <ion-card-content>
      <div class="mobile-card-content">
        <div class="info-row">
          <span class="label">Registros:</span>
          <span class="value">{{ table.rows | number }}</span>
        </div>

        <div class="info-row">
          <span class="label">Última Op:</span>
          <span class="value">{{ table.lastOp }}</span>
        </div>

        <div class="info-row" *ngIf="table.alerta">
          <span class="label">Alerta:</span>
          <span class="value alert-value">
            <ion-icon name="warning-outline"></ion-icon>
            {{ table.alerta }}
          </span>
        </div>
      </div>

      <div class="mobile-actions">
        <ion-button size="small" fill="outline">
          Configurar
        </ion-button>
        <ion-button size="small" fill="clear">
          Historial
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>
</div>

<!-- Estado vacío -->
<div *ngIf="tabla.length === 0" class="empty-state">
  <ion-icon name="search-outline" class="empty-icon"></ion-icon>
  <h3>No se encontraron resultados</h3>
  <p>Intenta ajustar los filtros de búsqueda</p>
  <ion-button fill="outline" (click)="limpiarFiltros()">
    Limpiar filtros
  </ion-button>
</div>

<ion-modal class="edit-modal" [isOpen]="showEditModal" (didDismiss)="closeEditModal()">
  <ng-template>
    <div class="modal-header">
      <h2>
        <ion-icon name="create-outline"></ion-icon>
        {{ selectedTableConfig ? 'Editar Tabla: ' + selectedTableConfig.name : 'Nueva Tabla' }}
      </h2>
      <ion-button fill="clear" class="close-btn" (click)="closeEditModal()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>

    <div class="modal-content">
      <!-- Información básica -->
      <div class="form-section">
        <h3>Información Básica</h3>
        <div class="form-group">
          <label>Nombre de la Tabla</label>
          <ion-input [(ngModel)]="editForm.name" placeholder="Ingresa el nombre de la tabla" clearInput="true"></ion-input>
          <div class="form-hint">El nombre debe ser único en la base de datos</div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Schema</label>
            <ion-select [(ngModel)]="editForm.schema" placeholder="Selecciona un schema">
              <ion-select-option value="public">public</ion-select-option>
              <ion-select-option value="admin">admin</ion-select-option>
              <ion-select-option value="reporting">reporting</ion-select-option>
            </ion-select>
          </div>
          <div class="form-group">
            <label>Tipo de Tabla</label>
            <ion-select [(ngModel)]="editForm.type" placeholder="Tipo">
              <ion-select-option value="table">Tabla Regular</ion-select-option>
              <ion-select-option value="view">Vista</ion-select-option>
              <ion-select-option value="materialized">Vista Materializada</ion-select-option>
            </ion-select>
          </div>
        </div>
        <div class="form-group">
          <label>Descripción</label>
          <ion-textarea [(ngModel)]="editForm.description" placeholder="Describe el propósito de esta tabla..." rows="3"></ion-textarea>
        </div>
      </div>

      <!-- Estado y configuración -->
      <div class="form-section">
        <h3>Estado y Configuración</h3>
        <div class="form-group">
          <label>Estado de la Tabla</label>
          <div class="status-selector">
            <div class="status-option" [class.active]="editForm.status === 'ACTIVA'" (click)="editForm.status = 'ACTIVA'">
              <ion-icon name="checkmark-circle"></ion-icon><span>ACTIVA</span>
            </div>
            <div class="status-option" [class.inactive]="editForm.status === 'INACTIVA'" (click)="editForm.status = 'INACTIVA'">
              <ion-icon name="close-circle"></ion-icon><span>INACTIVA</span>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Límite de Registros</label>
            <ion-input type="number" [(ngModel)]="editForm.rowLimit" placeholder="0 = Sin límite"></ion-input>
          </div>
          <div class="form-group">
            <label>Prioridad de Backup</label>
            <ion-select [(ngModel)]="editForm.backupPriority" placeholder="Selecciona prioridad">
              <ion-select-option value="high">Alta</ion-select-option>
              <ion-select-option value="medium">Media</ion-select-option>
              <ion-select-option value="low">Baja</ion-select-option>
            </ion-select>
          </div>
        </div>
        <div class="form-group">
          <div class="form-group-inline">
            <ion-checkbox [(ngModel)]="editForm.autoBackup"></ion-checkbox>
            <label>Habilitar backup automático</label>
          </div>
        </div>
        <div class="form-group">
          <div class="form-group-inline">
            <ion-checkbox [(ngModel)]="editForm.enableAudit"></ion-checkbox>
            <label>Habilitar auditoría de cambios</label>
          </div>
        </div>
      </div>

      <!-- Configuración avanzada -->
      <div class="form-section">
        <h3>Configuración Avanzada</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Retención de Datos (días)</label>
            <ion-input type="number" [(ngModel)]="editForm.dataRetention" placeholder="365"></ion-input>
          </div>
          <div class="form-group">
            <label>Compresión</label>
            <ion-select [(ngModel)]="editForm.compression" placeholder="Tipo de compresión">
              <ion-select-option value="none">Sin compresión</ion-select-option>
              <ion-select-option value="gzip">GZIP</ion-select-option>
              <ion-select-option value="lz4">LZ4</ion-select-option>
            </ion-select>
          </div>
        </div>
        <div class="form-group">
          <label>Índices Personalizados</label>
          <ion-textarea [(ngModel)]="editForm.customIndexes" placeholder="Especifica índices adicionales..." rows="2"></ion-textarea>
          <div class="form-hint">Separa múltiples índices con comas</div>
        </div>
      </div>

      <!-- Zona de peligro -->
      <div class="danger-zone" *ngIf="editForm.status === 'INACTIVA'">
        <h4>
          <ion-icon name="warning"></ion-icon> Zona de Peligro
        </h4>
        <p>Esta tabla está inactiva. Los datos pueden ser eliminados permanentemente si no se reactiva pronto.</p>
      </div>
    </div>

    <div class="modal-footer">
      <ion-button fill="outline" class="btn-delete" *ngIf="selectedTableConfig && editForm.status === 'INACTIVA'" (click)="deleteTable()">
        <ion-icon name="trash" slot="start"></ion-icon> Eliminar Permanentemente
      </ion-button>
      <div class="btn-group">
        <ion-button fill="outline" class="btn-cancel" (click)="closeEditModal()">Cancelar</ion-button>
        <ion-button class="btn-save" (click)="saveChanges()">
          <ion-icon name="save" slot="start"></ion-icon> {{ selectedTableConfig ? 'Guardar Cambios' : 'Crear Tabla' }}
        </ion-button>
      </div>
    </div>
  </ng-template>
</ion-modal>


<!-- MODAL PARA EDITAR DATOS DE TABLA -->
<ion-modal class="edit-data-modal" [isOpen]="showEditDataModal" (didDismiss)="closeEditDataModal()">
  <ng-template>
    <div class="modal-header">
      <h2>
        <ion-icon name="create-outline"></ion-icon>
        {{ editingRecord ? 'Editar Registro' : 'Nuevo Registro' }} - {{ selectedTableData?.name }}
      </h2>
      <ion-button 
        fill="clear" 
        class="close-btn"
        (click)="closeEditDataModal()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </div>

    <div class="modal-content">
      <!-- Información de la tabla -->
      <div class="table-info-section">
        <div class="table-summary">
          <div class="summary-item">
            <ion-icon name="layers-outline"></ion-icon>
            <span>{{ getTableColumns(selectedTableData?.name).length }} campos</span>
          </div>
          <div class="summary-item">
            <ion-icon name="documents-outline"></ion-icon>
            <span>{{ selectedTableData?.rows | number }} registros totales</span>
          </div>
          <div class="summary-item" *ngIf="editingRecord">
            <ion-icon name="create-outline"></ion-icon>
            <span>Editando registro ID: {{ recordForm.id || 'Nuevo' }}</span>
          </div>
        </div>
      </div>

      <!-- Formulario de datos -->
      <div class="data-form">
        <div class="form-section">
          <h3>
            <ion-icon name="document-text-outline"></ion-icon>
            Datos del Registro
          </h3>
          
          <div class="form-grid">
            <div 
              *ngFor="let column of getTableColumns(selectedTableData?.name)" 
              class="form-field"
              [class.readonly]="column.name === 'id' && editingRecord">
              
              <label class="field-label">
                {{ column.name }}
                <span class="field-type">{{ column.type }}</span>
                <ion-icon 
                  *ngIf="!column.isNullable" 
                  name="star" 
                  class="required-icon"
                  title="Campo obligatorio">
                </ion-icon>
              </label>

              <!-- Campo ID (solo lectura en edición) -->
              <ion-input
                *ngIf="column.name === 'id'"
                [value]="recordForm[column.name]"
                [readonly]="editingRecord"
                [placeholder]="editingRecord ? 'Auto-generado' : 'Auto-generado'"
                class="field-input readonly-input">
              </ion-input>

              <!-- Campo de texto -->
              <ion-input
                *ngIf="column.type === 'VARCHAR' || column.type === 'TEXT' && column.name !== 'id'"
                [(ngModel)]="recordForm[column.name]"
                [placeholder]="getPlaceholder(column)"
                [maxlength]="column.length"
                clearInput="true"
                class="field-input">
              </ion-input>

              <!-- Campo numérico -->
              <ion-input
                *ngIf="(column.type === 'INTEGER' || column.type === 'BIGINT' || column.type === 'DECIMAL') && column.name !== 'id'"
                [(ngModel)]="recordForm[column.name]"
                type="number"
                [placeholder]="getPlaceholder(column)"
                class="field-input">
              </ion-input>

              <!-- Campo booleano -->
              <div *ngIf="column.type === 'BOOLEAN'" class="boolean-field">
                <ion-segment [(ngModel)]="recordForm[column.name]" class="boolean-segment">
                  <ion-segment-button value="true">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    <ion-label>Verdadero</ion-label>
                  </ion-segment-button>
                  <ion-segment-button value="false">
                    <ion-icon name="close-circle"></ion-icon>
                    <ion-label>Falso</ion-label>
                  </ion-segment-button>
                </ion-segment>
              </div>

              <!-- Campo de fecha -->
              <ion-datetime
                *ngIf="column.type === 'DATE'"
                [(ngModel)]="recordForm[column.name]"
                presentation="date"
                class="field-input">
              </ion-datetime>

              <!-- Campo de fecha y hora -->
              <ion-datetime
                *ngIf="column.type === 'TIMESTAMP'"
                [(ngModel)]="recordForm[column.name]"
                presentation="date-time"
                class="field-input">
              </ion-datetime>

              <!-- Campo JSON -->
              <ion-textarea
                *ngIf="column.type === 'JSON'"
                [(ngModel)]="recordForm[column.name]"
                [placeholder]="getPlaceholder(column)"
                rows="4"
                class="field-input json-input">
              </ion-textarea>

              <!-- Campo UUID -->
              <div *ngIf="column.type === 'UUID'" class="uuid-field">
                <ion-input
                  [(ngModel)]="recordForm[column.name]"
                  [placeholder]="getPlaceholder(column)"
                  class="field-input">
                </ion-input>
                <ion-button 
                  fill="outline" 
                  size="small"
                  (click)="generateUUID(column.name)">
                  <ion-icon name="refresh"></ion-icon>
                  Generar
                </ion-button>
              </div>

              <!-- Validación y ayuda -->
              <div class="field-info">
                <span 
                  *ngIf="column.length" 
                  class="field-hint">
                  Máximo {{ column.length }} caracteres
                </span>
                <span 
                  *ngIf="column.defaultValue" 
                  class="field-hint">
                  Por defecto: {{ column.defaultValue }}
                </span>
                <span 
                  *ngIf="getFieldError(column.name)" 
                  class="field-error">
                  {{ getFieldError(column.name) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista previa del SQL -->
        <div class="sql-preview-section" *ngIf="showSQLPreview">
          <h4>
            <ion-icon name="code-slash"></ion-icon>
            SQL que se ejecutará
          </h4>
          <div class="sql-code">
            <pre>{{ generateDataSQL() }}</pre>
          </div>
          <ion-button 
            size="small" 
            fill="outline" 
            (click)="copySQLToClipboard()">
            <ion-icon name="copy" slot="start"></ion-icon>
            Copiar SQL
          </ion-button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="footer-actions-left">
        <ion-button 
          fill="outline" 
          color="medium"
          (click)="showSQLPreview = !showSQLPreview">
          <ion-icon name="code-slash" slot="start"></ion-icon>
          {{ showSQLPreview ? 'Ocultar' : 'Ver' }} SQL
        </ion-button>
        
        <ion-button 
          *ngIf="editingRecord"
          fill="outline" 
          color="danger"
          (click)="deleteRecord()">
          <ion-icon name="trash" slot="start"></ion-icon>
          Eliminar
        </ion-button>
      </div>

      <div class="btn-group">
        <ion-button 
          fill="outline" 
          class="btn-cancel"
          (click)="closeEditDataModal()">
          Cancelar
        </ion-button>
        
        <ion-button 
          class="btn-save"
          (click)="saveRecord()"
          [disabled]="!isFormValid()">
          <ion-icon name="save" slot="start"></ion-icon>
          {{ editingRecord ? 'Actualizar' : 'Crear' }} Registro
        </ion-button>
      </div>
    </div>
  </ng-template>
</ion-modal>
